<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Redirect</title>
    <meta name="robots" content="noindex, nofollow">
    <style>
        /* ... (rest of your existing styles) ... */
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <div class="text">Securing your connection...</div>
        <div class="progress">
            <div class="progress-bar"></div>
        </div>
        <div class="fallback hidden" id="fallback">
            <a href="#" id="fallbackLink">Click here if not redirected</a>
        </div>
    </div>

    <script>
        (function() {
            'use strict';

            const params = new URLSearchParams(window.location.search);
            const shortId = params.get('s');
            const originalUrl = params.get('u');

            const CONFIG = {
                BACKEND_URL: 'https://pickandpartner.nextdevs.me',
                IMMEDIATE_REDIRECT: true,
                MAX_REDIRECT_ATTEMPTS: 3,
                FALLBACK_DELAY: 1200
            };

            let redirected = false;
            let redirectAttempts = 0;
            let fingerprintLoaded = false;

            async function getVisitorIdWithFP() {
                try {
                    const fpPromise = import("https://fpjscdn.net/v3/q3B3Rzgfic7PLQfqdChA");
                    const fpJSModule = await Promise.race([
                        fpPromise,
                        new Promise((_, reject) => setTimeout(() => reject("FingerprintJS timeout"), 3000))
                    ]);

                    if (fpJSModule) {
                        const fp = await fpJSModule.load();
                        const result = await fp.get();
                        const visitorId = result.visitorId;
                        localStorage.setItem("visitorId", visitorId);
                        fingerprintLoaded = true;
                        return visitorId;
                    } else {
                        console.warn("FingerprintJS failed to load.");
                        return localStorage.getItem("visitorId") || generateFallbackVisitorId();
                    }
                } catch (error) {
                    console.error("Error loading FingerprintJS:", error);
                    return localStorage.getItem("visitorId") || generateFallbackVisitorId();
                }
            }

            function generateFallbackVisitorId() {
                const timestamp = Date.now().toString(36);
                const random = Math.random().toString(36).substring(2, 8);
                return `fb_${timestamp}_${random}`;
            }

            function getCachedVisitorId() {
                return localStorage.getItem("visitorId") || getVisitorIdWithFP();
            }

            function safeRedirect(url) {
                if (redirected || !url || redirectAttempts >= CONFIG.MAX_REDIRECT_ATTEMPTS) {
                    return;
                }

                redirected = true;
                redirectAttempts++;

                try {
                    if (redirectAttempts === 1) {
                        window.location.replace(url);
                        return;
                    }
                    if (redirectAttempts === 2) {
                        window.location.href = url;
                        return;
                    }
                    if (redirectAttempts === 3) {
                        window.open(url, '_self');
                        return;
                    }
                } catch (error) {
                    console.warn('Redirect failed:', error);
                    redirected = false;
                }
            }

            async function trackVisitor() {
                if (!shortId) return;

                try {
                    const visitorId = await getCachedVisitorId();
                    const city = localStorage.getItem('user_city') || 'Unknown';

                    if (city === 'Unknown') {
                        fetch('https://ipapi.co/city/', {
                            method: 'GET',
                            signal: AbortSignal.timeout(400)
                        })
                        .then(response => response.ok ? response.text() : Promise.reject())
                        .then(cityName => {
                            if (cityName && cityName.trim()) {
                                localStorage.setItem('user_city', cityName.trim());
                            }
                        })
                        .catch(() => {});
                    }

                    const trackingData = {
                        shortId,
                        visitorId,
                        city: localStorage.getItem('user_city') || 'Unknown',
                        additionalData: {
                            referrer: document.referrer || 'direct',
                            timestamp: Date.now()
                        }
                    };

                    fetch(`${CONFIG.BACKEND_URL}/track`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(trackingData),
                        keepalive: true,
                        signal: AbortSignal.timeout(800)
                    }).catch(() => {});

                } catch (error) {
                    console.error("Tracking error:", error);
                }
            }

            function showFallback() {
                setTimeout(() => {
                    if (!redirected && originalUrl) {
                        const fallbackDiv = document.getElementById('fallback');
                        const fallbackLink = document.getElementById('fallbackLink');

                        if (fallbackDiv && fallbackLink) {
                            fallbackLink.href = originalUrl;
                            fallbackDiv.classList.remove('hidden');
                        }
                    }
                }, CONFIG.FALLBACK_DELAY);
            }

            async function init() {
                if (originalUrl) {
                    if (CONFIG.IMMEDIATE_REDIRECT) {
                        safeRedirect(originalUrl);
                    }
                    setTimeout(() => safeRedirect(originalUrl), 100);
                    setTimeout(() => safeRedirect(originalUrl), 500);
                    showFallback();
                }

                // Initiate tracking after a short delay to not block redirect
                setTimeout(trackVisitor, 200);
            }

            if (document.readyState === 'complete') {
                init();
            } else {
                window.addEventListener('load', init);
                document.addEventListener('DOMContentLoaded', init);
            }

            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && originalUrl && !redirected) {
                    safeRedirect(originalUrl);
                }
            });

            window.addEventListener('pageshow', (event) => {
                if (event.persisted && originalUrl && !redirected) {
                    safeRedirect(originalUrl);
                }
            });

            setTimeout(() => {
                if (originalUrl && !redirected) {
                    safeRedirect(originalUrl);
                }
            }, 2000);

        })();
    </script>
</body>
</html>